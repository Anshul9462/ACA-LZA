# Enterprise Scale for ACA Internal  - Bicep Implementation

A deployment of ACA-hosted workloads typically experiences a separation of duties and lifecycle management in the area of prerequisites, the host network, the cluster infrastructure, and finally the workload itself. This reference implementation  can be used with two different ways, as explained next. The primary purpose of this implementation is to illustrate the topology and decisions of a secure baseline Azure Container Apps environment. 

## Prerequisites 
- Clone this repo (you may need to fork it, if you wish to utilize the [LZA Deployment Github Action](../../../.github/workflows/lza-deployment.yml))
- Install [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli)
- Install [bicep tools](https://docs.microsoft.com/azure/azure-resource-manager/bicep/install)
- Register the following Azure Resource Providers (if not already registered)
  -  Microsoft.App
       
        ```bash
        # check if provider is already registered
        az provider list --query "[?namespace=='Microsoft.App'].{Provider:namespace, Status:registrationState}" --output table

        # if provider is not registered, register it
        az provider register --namespace 'Microsoft.App'

        ```
  -  Microsoft.ContainerService
        
        ```bash
        # check if provider is already registered
        az provider list --query "[?namespace=='Microsoft.ContainerService'].{Provider:namespace, Status:registrationState}" --output table

        # if provider is not registered, register it
        az provider register --namespace 'Microsoft.ContainerService'

        ```

### Resource Naming Convention
An effective naming convention consists of resource names from important information about each resource. A good name helps you quickly identify the resource's type, associated workload, environment, and the Azure region hosting it. The naming of the resources in this implementation follow [Azure Best Practices](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming). Your organization might has already a naming strategy in place, which possibly deviates from the current implementation. The naming of the resources, is automated and centralized, so that in most of the cases can be easily modified or even overriden. The naming module consists of two files
-  [naming-rules.jsonc](../../shared/bicep/naming/naming-rules.jsonc). In this file you can override: 
   -  the abbreviation of the resources (`resourceTypeAbbreviations`), which currently follows Azure [recommended abreviations](https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-abbreviations). 
   -  the list of azure regions and their abbreviation (`regionAbbreviations`) (NOTE: the list may not be complete - check if the region you plan to deploy is included)
-  [naming.module.bicep](../../shared/bicep/naming/naming.module.bicep). In this file you can change the way the names are generated, by swapping or removing tokens, adding string identifiers etc. 

### Standalone Deployment Guide

You can deploy the complete landing zone in a single subscription, by using the [main.bicep](main.bicep) template file and the accompanying [main.parameters.jsonc](main.parameters.jsonc) parameter file. You need first to check and customize the parameter file (parameters are described below) and then decide whether you intend to deploy the simple [Hello World App](modules/05-hello-world-sample-app/README.md) or the more comprehensive, Dapr-enabled [Fine Collection Sample App](sample-apps/java-fine-collection-service/docs/02-container-apps.md). If you intend to deploy the [Fine Collection Sample App](sample-apps/java-fine-collection-service/docs/02-container-apps.md), we reccomend that you set the parameter `deployHelloWorldSample` to `false`. 


#### Deployment Parameters
The table below summurizes the avaialble parameters and the possible values that can be set. 

| Name | Description | Example | 
|------|-------------|---------|
|workloadName|A suffix that will be used to name the resources in a pattern similar to ` <resourceAbbreviation>-<applicationName> ` . Must be up to 10 characters long, alphanumeric with dashes|app-svc-01|
|environment|Required. The name of the environment (e.g. "dev", "test", "prod", "preprod", "staging", "uat", "dr", "qa"). Up to 8 characters long.||
|tags|Resource tags that we might need to add to all resources (i.e. Environment, Cost center, application name etc)|"tags": {<br>         "value": { <br>               "deployment": "bicep", <br>  "key1": "value1" <br>           } <br>         } |
| enableTelemetry | boolean, Telemetry collection is on by default `true` | | 
| hubResourceGroupName | Optional default value `""`, The name of the hub resource group to create the resources in. If set, it overrides the name generated by the template | | 
| spokeResourceGroupName | Optional default value `""`, The name of the spoke resource group to create the resources in. If set, it overrides the name generated by the template | | 
| vnetAddressPrefixes | An array of string. The address prefixes to use for the hub virtual network. | | 
| bastionSubnetAddressPrefix | CIDR to use for the Azure Bastion subnet |  | 
| vmSize | The size of the virtual machine to create. | [VM Sizes](https://docs.microsoft.com/en-us/azure/virtual-machines/sizes)  | 
| vmAdminUsername | The username to use for the virtual machine |  | 
| vmAdminPassword | The password to use for the virtual machine |  | 
| vmLinuxSshAuthorizedKeys | The SSH public key to use for the virtual machine (if VM is linux) |  | 
| vmJumpboxOSType | The type of OS for the deployed jumbbox - Can be `linux` or `windows` |  | 
| vmJumpBoxSubnetAddressPrefix | CIDR to use for the virtual machine subnet |  | 
| spokeVNetAddressPrefixes | An array of string. The address prefixes to use for the spoke virtual network |  | 
| spokeInfraSubnetAddressPrefix | CIDR of the Spoke Infrastructure Subnet |  | 
| spokePrivateEndpointsSubnetAddressPrefix | CIDR of the Spoke Private Endpoints Subnet |  | 
| spokeApplicationGatewaySubnetAddressPrefix | CIDR of the Spoke Application Gateway Subnet |  | 
| enableApplicationInsights | If you want to deploy Application Insights, set this to `true` |  |
| enableDaprInstrumentation | If you use Dapr, you can setup Dapr telemetry by setting this to true and enableApplicationInsights to `true` |  |
| deployHelloWorldSample | Set this to `true` if you want to deploy the sample application and the application gateway |NOTE: if you prefer to deploy the more comprehensive, Dapr-enabled [Fine Collection Sample App](sample-apps/java-fine-collection-service/docs/02-container-apps.md) set this parameter to `false` |


After the parameters have been initialized, you can deploy the Landing Zone Accelerator resources with the following `az cli` command:


#### Bash shell (i.e. inside WSL2 for windows 11, or any linux-based OS)
``` bash
LOCATION=northeurope # or any location that suits your needs
LZA_DEPLOYMENT_NAME=bicepAcaLzaDeployment  # or any other value that suits your needs

az deployment sub create \
    --template-file main.bicep \
    --location $LOCATION \
    --name $LZA_DEPLOYMENT_NAME \
    --parameters ./main.parameters.local.jsonc
```

#### Powershell (windows based OS)
``` powershell
$LOCATION=northeurope # or any location that suits your needs
$LZA_DEPLOYMENT_NAME=bicepAcaLzaDeployment  # or any other value that suits your needs

az deployment sub create `
    --template-file main.bicep `
    --location $LOCATION `
    --name $LZA_DEPLOYMENT_NAME `
    --parameters ./main.parameters.local.jsonc
```
After your Hub, Spoke, supporting services and Azure Container Apps Environment are deployed (and if you selected `deployHelloWorldSample: false`) you may proceed to deploy Fine Collection Sample App
:arrow_forward: [Fine Collection Sample App](sample-apps/java-fine-collection-service/docs/02-container-apps.md)

#### Cleanup

To remove the resources created by this landing zone, you can use the following command:

```bash
$LZA_DEPLOYMENT_NAME=bicepAcaLzaDeployment  # The name of the deployment you used in the previous step

# get the name of the Spoke Resource Group that has been created previously
SPOKE_RESOURCE_GROUP_NAME=$(az deployment sub show -n "$LZA_DEPLOYMENT_NAME" --query properties.outputs.spokeResourceGroupName.value -o tsv)

# get the name of the Hub Resource Group that has been created previously
HUB_RESOURCE_GROUP_NAME=$(az deployment sub show -n "$LZA_DEPLOYMENT_NAME" --query properties.outputs.hubResourceGroupName.value -o tsv)

az group delete -n $SPOKE_RESOURCE_GROUP_NAME --yes
az group delete -n $HUB_RESOURCE_GROUP_NAME --yes
```

### Standalone Deployment Guide With Github Action
With this method, you can leverage the included [LZA Deployment github action](../../../.github/workflows/lza-deployment.yml) to deploy the Azure Container Apps Infrastructure resources. 
> NOTE: To use the github action you need to [fork the repository](https://github.com/Azure/ACA-Landing-Zone-Accelerator/fork) to your organization. 

#### Setup authentication between Azure and GitHub.
The easiest way to do that, is to use a [service principal](https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Cwindows#use-the-azure-login-action-with-a-service-principal-secret). 
 1. Open [Azure Cloud Shell](https://docs.microsoft.com/en-us/azure/cloud-shell/overview) in the Azure Portal or [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) locally
2. Create a new service principal in the Azure portal for your app and assign it **Contributor** role. Replace {subscription-id}. The service principal will be created at the scope of the subscription as multiple resource groups will be created.
   ```
   az ad sp create-for-rbac --name "myApp" --role owner \
                       --scopes /subscriptions/{subscription-id} \
                       --sdk-auth
   ```
3. Copy the JSON object for your service principal
   ```json
   {
       "clientId": "<GUID>",
       "clientSecret": "<GUID>",
       "subscriptionId": "<GUID>",
       "tenantId": "<GUID>",
       (...)
   }
   ```
4. Navigate to where you cloned the GitHub repository and go to **Settings** > **Secrets and variables** > **Actions** > **New repository secret**.
5. Create a new secret called `AZURE_CREDENTIALS` with the JSON information in step 3 (in JSON format).

#### Modify/Parametrize the github Action
The [LZA Deployment Github Action](../../../.github/workflows/lza-deployment.yml) can be triggered manually, or automatically When a pull request is issued for the main branch. There are two importan environment variables
- `LOCATION`: Default value is `northeurope`, but you may wish to change it to deploy in a region of your choice 
- `ENABLE_TEARDOWN`: Default value is `true`, which means that the deployment will be cleaned up at the end (after manual approval or after 120 minutes have expired). If you wish not to clean up automatically the resources you need to change that value to `false`. 

### End-to-End Deployment with Sample Application

With this method of deployment, you can leverage the step-by-step process, where possibly different teams (devops, network, operations etc) with different levels of access, are required to co-ordinate and deploy all of the required resources. Make any necessary adjustments to the variables and settings within that folder to match the needs of your deployment. Please read carrefully the documentation of each step before deploying it. All bicep templates parameters are documented in the bicep templates.

1. Preqs - Clone this repo, install [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli), install [Bicep tools](https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/install)
2. [Hub](modules/01-hub/README.md)
3. [Spoke](modules/02-spoke/README.md)
4. [Supporting Services](modules/03-supporting-services/README.md)
5. [ACA Environment](modules/04-container-apps-environment/README.md)
6. [Hello World Sample Container App (Optional)](modules/05-hello-world-sample-app/README.md)
7. [Application Gateway](modules/06-application-gateway/README.md) or [Front Door](modules/06-front-door/README.md)  